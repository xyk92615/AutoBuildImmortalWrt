# æ­¤å·¥ä½œæµæ˜¯ä¸ºäº†æ„å»ºä¸€ä¸ªimmortalwrtå›ºä»¶çš„å®‰è£…å™¨ æ ¼å¼ä¸ºiso å¯ç”¨äºæ‰€æœ‰çš„è™šæ‹Ÿæœº å’Œ ç‰©ç†æœº
# æ‰€è°“å®‰è£…å™¨å°±æ˜¯ç”¨æ¥å®‰è£…ç”¨çš„ isoå¼•å¯¼çš„æ˜¯ä¸€ä¸ªå¯åŠ¨é€Ÿåº¦æå¿«çš„debian liveç³»ç»Ÿ è·‘ç åè¾“å…¥å‘½ä»¤ ddd å³å¯è°ƒå‡ºå®‰è£…èœå•
# å®‰è£…æ—¶ è‹¥æ˜¯å¤šå¼ ç¡¬ç›˜ ä½ å¯ä»¥é€‰æ‹© éœ€è¦å®‰è£…çš„ç¡¬ç›˜ æ­¤ç±»æ–¹æ³•å®‰è£…çš„openwrt å®‰è£…åæ˜¯æœ‰å‰©ä½™ç©ºé—´çš„ æ›´å¤šä¿¡æ¯è¯·å‚è€ƒ wukongdaily/img-installer é¡¹ç›®
# å‡ ä¹æ‰€æœ‰linux éƒ½æœ‰å„è‡ªçš„å®‰è£…å™¨ å”¯ç‹¬openwrtå’Œarmbian æ²¡æœ‰, å¸Œæœ›æ­¤å·¥ä½œæµ å¼¥è¡¥è¿™ä¸ªé—æ†¾ è®©ä½ æ›´ä¼˜é›…çš„ å®‰è£…openwrt 

name: build ISO

on:
  workflow_dispatch:
    inputs:
      luci_version:
        description: "é€‰æ‹©luciç‰ˆæœ¬"
        required: false
        default: "24.10.4"
        type: choice
        options:
          - 24.10.0
          - 24.10.1
          - 24.10.2
          - 24.10.3
          - 24.10.4
      profile:
        description: 'è¯·è¾“å…¥è¦ç¼–è¯‘å›ºä»¶å¤§å° å•ä½(MB)'
        required: true
        default: '4096'
      include_docker:
        description: "æ˜¯å¦ç¼–è¯‘ Docker æ’ä»¶"
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'
      enable_store:
        description: "é›†æˆ store å•†åº—"
        required: false
        type: boolean
        default: true
      enable_pppoe:
        description: "æ˜¯å¦é…ç½®PPPoEæ‹¨å·ä¿¡æ¯?"
        required: true
        default: 'no'
        type: choice
        options:
          - 'yes'
          - 'no'
      pppoe_account:
        description: "å®½å¸¦è´¦å· (è‹¥å¯ç”¨PPPoE)"
        required: false
      pppoe_password:
        description: "å®½å¸¦å¯†ç  (è‹¥å¯ç”¨PPPoE)"
        required: false

jobs:
    build_installer_iso:
      runs-on: ubuntu-22.04
      needs: build_immortalwrt

      steps:
        - name: Download firmware artifact
          uses: actions/download-artifact@v4
          with:
            name: firmware-img
  
        - name: â¬ åŒæ­¥ img-installer é¡¹ç›® å‡†å¤‡åˆ¶ä½œISO
          run: |
            git clone https://github.com/wukongdaily/img-installer.git
            cd img-installer

        - name: Set executable permissions for scripts
          run: |
            chmod +x "${{ github.workspace }}/img-installer/custom.sh"
            chmod +x "${{ github.workspace }}/img-installer/supportFiles/custom/build.sh"

        - name: âœ… åˆ¶ä½œ ISO
          run: |
            firmware_file=$(ls *squashfs-combined-efi.img.gz)
            cd img-installer
            bash autobuild/autobuild.sh "../$firmware_file"

        # ğŸ‘‰ æ–°å¢ï¼šæ ¹æ®å‚æ•°å’Œæ—¶é—´ç”Ÿæˆ tag
        - name: ğŸ”§ ç”Ÿæˆ Release Tag
          id: set_tag
          run: |
            LUCI_VERSION="${{ github.event.inputs.luci_version }}"
            PROFILE="${{ github.event.inputs.profile }}"
            INCLUDE_DOCKER="${{ github.event.inputs.include_docker }}"
            ENABLE_STORE="${{ github.event.inputs.enable_store }}"

            # Docker æ ‡å¿—
            if [ "$INCLUDE_DOCKER" = "yes" ]; then
              DOCKER_FLAG="Docker"
            else
              DOCKER_FLAG="NoDocker"
            fi

            # Store æ ‡å¿—ï¼ˆboolean: true/falseï¼‰
            if [ "$ENABLE_STORE" = "true" ]; then
              STORE_FLAG="Store"
            else
              STORE_FLAG="NoStore"
            fi

            # æ—¥æœŸæ—¶é—´ï¼š202511190101 è¿™ç§æ ¼å¼
            DATE="$(date +'%Y%m%d%H%M')"
  
            TAG="Custom-Installer-x86_64-ISO_${LUCI_VERSION}_${PROFILE}M_${DOCKER_FLAG}_${STORE_FLAG}_${DATE}"
  
            echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"

        - name: ğŸš€ ä¸Šä¼  ISO åˆ° Release
          uses: softprops/action-gh-release@v2.2.1
          with:
            tag_name: ${{ steps.set_tag.outputs.tag_name }}   # ğŸ‘ˆ ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„ tag
            name: ${{ steps.set_tag.outputs.tag_name }}       # å¯é€‰ï¼šRelease åç§°ä¹Ÿç”¨åŒä¸€ä¸ª
            body_path: "${{ github.workspace }}/img-installer/autobuild/info.md"
            files: |
              img-installer/output/custom-installer-x86_64.iso
            token: "${{ secrets.GITHUB_TOKEN }}"
